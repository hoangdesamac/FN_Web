<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra cứu đơn hàng - 3TD Shop</title>
    <link rel="icon" type="image/png" href="Image_Showroom/Slogan_w_logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <link rel="stylesheet" href="HTML/Style/resetlookup.css">
    <link rel="stylesheet" href="HTML/Style/common.css">
    <script>
        window.API_BASE = "https://fn-web.onrender.com";
        // short grace window (ms) to avoid accidental modal popups right on page load
        window.__preventAutoOpenUntil = Date.now() + 1200;
    </script>

    <!-- AuthSync: canonical auth synchronizer (loads early) -->
    <script src="Script/js_authsync.js" defer></script>
    <script src="Script/js_cartcount.js" defer></script>
    <script src="Script/js_ordercount.js" defer></script>

    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <!-- Flatpickr CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

</head>
<body class="cyber-main">
<div id="header-container"></div>

<div class="container lookup-container cyber-main">
    <div class="breadcrumb-steps d-flex justify-content-between align-items-center mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="index.html">Trang chủ</a></li>
                <li class="breadcrumb-item active" aria-current="page">Tra cứu đơn hàng</li>
            </ol>
        </nav>
    </div>

    <h1 class="cart-title">Tra cứu đơn hàng</h1>

    <div class="search-filter mb-4 p-4 rounded">
        <div class="search-bar-lookup row g-3">
            <div class="col-md-3">
                <input type="text" class="form-control" id="product-keyword" placeholder="Tìm kiếm theo tên sản phẩm">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="status-filter">
                    <option value="all">Tất cả trạng thái</option>
                    <option value="Đơn hàng đang xử lý">Đang xử lý</option>
                    <option value="Đơn hàng đang được vận chuyển">Đang vận chuyển</option>
                    <option value="Đơn hàng đã hoàn thành">Đã hoàn thành</option>
                    <option value="Đơn hàng đã hủy">Đã hủy</option>
                </select>
            </div>
            <div class="col-md-2">
                <div class="input-group datepicker-wrapper">
                    <input type="text" class="form-control" id="start-date" placeholder="Ngày bắt đầu">
                    <span class="input-group-text start-date-icon">
                        <i class='bx bx-calendar'></i>
                    </span>
                </div>
            </div>
            <div class="col-md-2">
                <div class="input-group datepicker-wrapper">
                    <input type="text" class="form-control" id="end-date" placeholder="Ngày kết thúc">
                    <span class="input-group-text end-date-icon">
                         <i class='bx bx-calendar'></i>
                    </span>
                </div>
            </div>

            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="applyFilters()"><i class="bx bx-search"></i> Tìm kiếm</button>
            </div>
        </div>
    </div>

    <div id="searching-animation" class="loading text-center d-none">
        <lottie-player src="/transformanimation/orderprocessing.json" background="transparent" speed="1" style="width: 100px; height: 100px; margin: 0 auto;" loop autoplay></lottie-player>
        <p>Đang tìm kiếm đơn hàng...</p>
    </div>

    <div id="orders-container" class="orders-container"></div>

    <div id="empty-orders" class="empty-orders text-center d-none">
        <lottie-player src="/transformanimation/emptycart.json" background="transparent" speed="1" style="width: 200px; height: 200px; margin: 0 auto;" loop autoplay></lottie-player>
        <h2>Chưa có đơn hàng nào</h2>
        <a href="index.html" class="btn btn-primary continue-shopping-btn">Tiếp tục mua sắm</a>
    </div>

    <div id="reward-popup" class="reward-popup-overlay d-none">
        <div class="reward-popup">
            <h3>Thông báo</h3>
            <p>Hoàn tất nhận hàng để tiến hành nhận thưởng</p>
            <button class="btn btn-success" onclick="closeRewardPopup()">OK</button>
        </div>
    </div>

    <div id="pdf-render-area" style="display: none;"></div>
</div>

<div id="footer-container"></div>

<audio id="newcard-sound" src="/audioanimation/newcard.mp3"></audio>
<audio id="swish-sound" src="/audioanimation/flipped.mp3"></audio>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>

<!-- Page scripts -->
<script src="Script/js_resetlookup.js"></script>
<script src="Script/js_header.js"></script>
<script src="Script/js_resetcheckout.js" defer></script>

<!-- Inject auth script only after header exists, then sync auth with server.
     Use safe consume-on-read pattern to decide whether to open the login modal.
     We avoid directly reading localStorage.getItem('showLoginAfterReset') here. -->
<script>
    (function() {
        // minimal fallback consumer if central helper not present yet
        function safeConsumeFlagFallback() {
            try {
                if (typeof sessionStorage !== 'undefined' && sessionStorage.getItem('showLoginAfterReset') === 'true') {
                    try { sessionStorage.removeItem('showLoginAfterReset'); } catch (_) {}
                    return true;
                }
                const v = localStorage.getItem('showLoginAfterReset');
                if (!v) return false;
                const ts = Number(localStorage.getItem('showLoginAfterReset_ts') || '0');
                if (ts && (Date.now() - ts) < 10 * 1000) {
                    try { localStorage.removeItem('showLoginAfterReset'); localStorage.removeItem('showLoginAfterReset_ts'); } catch (_) {}
                    return true;
                }
                try { localStorage.removeItem('showLoginAfterReset'); localStorage.removeItem('showLoginAfterReset_ts'); } catch (_) {}
                return false;
            } catch (e) {
                try { localStorage.removeItem('showLoginAfterReset'); localStorage.removeItem('showLoginAfterReset_ts'); } catch (_) {}
                try { sessionStorage.removeItem('showLoginAfterReset'); } catch (_) {}
                return false;
            }
        }

        // Non-destructive guard for CyberModal.open — blocks auto-open during initial grace window
        (function guardCyberModalOpen() {
            function wrap() {
                if (!window.CyberModal || window.CyberModal.__openGuarded) return;
                const orig = window.CyberModal.open.bind(window.CyberModal);
                window.CyberModal.open = function(...args) {
                    try {
                        let consumed = false;
                        if (typeof window._consumeShowLoginFlag === 'function') {
                            try { consumed = !!window._consumeShowLoginFlag(); } catch (e) { consumed = false; }
                        } else {
                            consumed = safeConsumeFlagFallback();
                        }

                        if (consumed) return orig(...args);

                        if (Date.now() < (window.__preventAutoOpenUntil || 0)) {
                            console.info('Blocked CyberModal.open during initial grace period (lookup).');
                            return;
                        }
                        return orig(...args);
                    } catch (e) {
                        try { return orig(...args); } catch (_) {}
                    }
                };
                window.CyberModal.__openGuarded = true;
            }

            const p = setInterval(() => {
                try { wrap(); } catch (_) {}
                if (window.CyberModal && window.CyberModal.__openGuarded) clearInterval(p);
            }, 80);
            document.addEventListener('DOMContentLoaded', wrap);
        })();

        // Show a gentle banner prompting login if user is guest and needs to access saved orders.
        function showLoginBannerIfGuest() {
            try {
                // quick logged check via AuthSync or localStorage compatibility keys
                let logged = false;
                try {
                    if (window.AuthSync && typeof window.AuthSync.getState === 'function') {
                        const st = window.AuthSync.getState();
                        logged = !!(st && st.loggedIn);
                    } else {
                        logged = !!localStorage.getItem('userId') || !!localStorage.getItem('userName');
                    }
                } catch (e) {
                    logged = !!localStorage.getItem('userId') || !!localStorage.getItem('userName');
                }
                if (logged) return;

                // create banner if absent
                if (!document.getElementById('lookup-login-banner')) {
                    const holder = document.querySelector('.lookup-container') || document.body;
                    const banner = document.createElement('div');
                    banner.id = 'lookup-login-banner';
                    banner.className = 'alert alert-warning d-flex justify-content-between align-items-center';
                    banner.style.marginBottom = '20px';
                    banner.innerHTML = `
                    <div>Bạn cần <strong>đăng nhập</strong> để xem đơn hàng.</div>
                    <div style="display:flex; gap:8px;">
                        <button id="lookup-login-open" class="btn btn-sm btn-primary">Đăng nhập</button>
                        <button id="lookup-login-dismiss" class="btn btn-sm btn-outline-secondary">Đóng</button>
                    </div>
                `;
                    holder.insertBefore(banner, holder.firstChild);

                    document.getElementById('lookup-login-open').addEventListener('click', () => {
                        try {
                            if (typeof window.setShowLoginAfterReset === 'function') window.setShowLoginAfterReset(true);
                            else if (typeof sessionStorage !== 'undefined') sessionStorage.setItem('showLoginAfterReset','true');
                        } catch (_) {}
                        if (typeof CyberModal !== 'undefined' && typeof CyberModal.open === 'function') {
                            CyberModal.open();
                        }
                    });

                    document.getElementById('lookup-login-dismiss').addEventListener('click', () => {
                        try { banner.remove(); } catch (_) {}
                    });
                }
            } catch (e) {
                console.warn('showLoginBannerIfGuest error', e);
            }
        }

        // Inject js_resetauth AFTER header exists so updateUserDisplay/updateCartCount exist
        let authInjected = false;
        function injectAuthScript() {
            if (authInjected) return;
            authInjected = true;

            const s = document.createElement('script');
            s.src = "Script/js_resetauth.js";
            s.defer = true;
            s.onload = async function() {
                try {
                    if (window.AuthSync && typeof window.AuthSync.refresh === 'function') {
                        await window.AuthSync.refresh();
                    }
                } catch (err) {
                    console.warn('AuthSync.refresh() failed (lookup):', err);
                }

                // Ensure header/cart/order UI updated
                try {
                    if (typeof updateUserDisplay === 'function') {
                        const p = updateUserDisplay();
                        if (p && typeof p.then === 'function') await p;
                    }
                    if (typeof updateCartCount === 'function') updateCartCount();
                    if (typeof updateOrderCount === 'function') updateOrderCount();
                } catch (e) {
                    console.warn('Post-refresh header update failed (lookup):', e);
                }

                // Safe consume: prefer exported helper, fallback to safe consumer
                let consumed = false;
                try {
                    if (typeof window._consumeShowLoginFlag === 'function') {
                        consumed = !!window._consumeShowLoginFlag();
                    } else if (typeof window.consumeShowLoginFlag === 'function') {
                        consumed = !!window.consumeShowLoginFlag();
                    } else {
                        consumed = safeConsumeFlagFallback();
                    }
                } catch (e) { consumed = false; }

                if (consumed) {
                    // Only auto-open if beyond grace window
                    if (Date.now() >= (window.__preventAutoOpenUntil || 0)) {
                        try { if (typeof CyberModal !== 'undefined' && typeof CyberModal.open === 'function') CyberModal.open(); } catch (_) {}
                    } else {
                        // schedule a small delayed open (best-effort) after grace window
                        setTimeout(() => {
                            try { if (typeof CyberModal !== 'undefined' && typeof CyberModal.open === 'function') CyberModal.open(); } catch (_) {}
                        }, Math.max(300, (window.__preventAutoOpenUntil || 0) - Date.now() + 150));
                    }
                } else {
                    // normal guest browsing: show gentle banner instead of forcing modal
                    try { showLoginBannerIfGuest(); } catch (e) {}
                }
            };
            document.body.appendChild(s);
        }

        // Wait for header-container injection then inject auth script
        const headerContainer = document.getElementById('header-container');
        if (headerContainer && headerContainer.children.length > 0) {
            injectAuthScript();
        } else if (headerContainer) {
            const obs = new MutationObserver((mutations, observer) => {
                for (const m of mutations) {
                    if (m.type === 'childList' && m.addedNodes.length > 0) {
                        injectAuthScript();
                        observer.disconnect();
                        return;
                    }
                }
            });
            obs.observe(headerContainer, { childList: true, subtree: false });
        } else {
            // fallback poll
            let tries = 0;
            const t = setInterval(() => {
                const hc = document.getElementById('header-container');
                tries++;
                if (hc && hc.children.length > 0) {
                    clearInterval(t);
                    injectAuthScript();
                } else if (tries > 40) {
                    clearInterval(t);
                    injectAuthScript();
                }
            }, 100);
        }

        // best-effort: show banner after small delay in case auth script not yet injected
        document.addEventListener('DOMContentLoaded', function() {
            try { setTimeout(showLoginBannerIfGuest, 450); } catch (e) {}
        });
    })();
</script>
</body>
</html>