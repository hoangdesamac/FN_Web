<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra cứu đơn hàng - 3TD Shop</title>
    <link rel="icon" type="image/png" href="Image_Showroom/Slogan_w_logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <link rel="stylesheet" href="HTML/Style/resetlookup.css">
    <link rel="stylesheet" href="HTML/Style/common.css">
    <script>
        window.API_BASE = "https://fn-web.onrender.com";
    </script>

    <!-- AuthSync: canonical auth synchronizer (loads early) -->
    <script src="Script/js_authsync.js" defer></script>

    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <!-- Flatpickr CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

</head>
<body class="cyber-main">
<div id="header-container"></div>

<div class="container lookup-container cyber-main">
    <div class="breadcrumb-steps d-flex justify-content-between align-items-center mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="index.html">Trang chủ</a></li>
                <li class="breadcrumb-item active" aria-current="page">Tra cứu đơn hàng</li>
            </ol>
        </nav>
    </div>

    <h1 class="cart-title">Tra cứu đơn hàng</h1>

    <div class="search-filter mb-4 p-4 rounded">
        <div class="search-bar-lookup row g-3">
            <div class="col-md-3">
                <input type="text" class="form-control" id="product-keyword" placeholder="Tìm kiếm theo tên sản phẩm">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="status-filter">
                    <option value="all">Tất cả trạng thái</option>
                    <option value="Đơn hàng đang xử lý">Đang xử lý</option>
                    <option value="Đơn hàng đang được vận chuyển">Đang vận chuyển</option>
                    <option value="Đơn hàng đã hoàn thành">Đã hoàn thành</option>
                    <option value="Đơn hàng đã hủy">Đã hủy</option>
                </select>
            </div>
            <div class="col-md-2">
                <div class="input-group datepicker-wrapper">
                    <input type="text" class="form-control" id="start-date" placeholder="Ngày bắt đầu">
                    <span class="input-group-text start-date-icon">
                        <i class='bx bx-calendar'></i>
                    </span>
                </div>
            </div>
            <div class="col-md-2">
                <div class="input-group datepicker-wrapper">
                    <input type="text" class="form-control" id="end-date" placeholder="Ngày kết thúc">
                    <span class="input-group-text end-date-icon">
                         <i class='bx bx-calendar'></i>
                    </span>
                </div>
            </div>

            <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="applyFilters()"><i class="bx bx-search"></i> Tìm kiếm</button>
            </div>
        </div>
    </div>

    <div id="searching-animation" class="loading text-center d-none">
        <lottie-player src="/transformanimation/orderprocessing.json" background="transparent" speed="1" style="width: 100px; height: 100px; margin: 0 auto;" loop autoplay></lottie-player>
        <p>Đang tìm kiếm đơn hàng...</p>
    </div>

    <div id="orders-container" class="orders-container"></div>

    <div id="empty-orders" class="empty-orders text-center d-none">
        <lottie-player src="/transformanimation/emptycart.json" background="transparent" speed="1" style="width: 200px; height: 200px; margin: 0 auto;" loop autoplay></lottie-player>
        <h2>Chưa có đơn hàng nào</h2>
        <a href="index.html" class="btn btn-primary continue-shopping-btn">Tiếp tục mua sắm</a>
    </div>

    <div id="reward-popup" class="reward-popup-overlay d-none">
        <div class="reward-popup">
            <h3>Thông báo</h3>
            <p>Hoàn tất nhận hàng để tiến hành nhận thưởng</p>
            <button class="btn btn-success" onclick="closeRewardPopup()">OK</button>
        </div>
    </div>

    <div id="pdf-render-area" style="display: none;"></div>
</div>

<div id="footer-container"></div>

<audio id="newcard-sound" src="/audioanimation/newcard.mp3"></audio>
<audio id="swish-sound" src="/audioanimation/flipped.mp3"></audio>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>

<!-- Page scripts -->
<script src="Script/js_resetlookup.js"></script>
<script src="Script/js_header.js"></script>
<script src="Script/js_resetcheckout.js" defer></script>

<!-- Inject auth script only after header exists, then sync auth with server.
     This prevents race conditions where header renders after auth and shows stale state. -->
<script>
    (function() {
        let authInjected = false;
        function injectAuthScript() {
            if (authInjected) return;
            authInjected = true;

            const s = document.createElement('script');
            s.src = "Script/js_resetauth.js";
            s.defer = true;
            s.onload = async function() {
                try {
                    if (window.AuthSync && typeof window.AuthSync.refresh === 'function') {
                        await window.AuthSync.refresh();
                    }
                } catch (err) {
                    console.warn('AuthSync.refresh() failed on lookup page:', err);
                }

                // legacy behavior: open modal flag
                try {
                    if (localStorage.getItem("showLoginAfterReset") === "true") {
                        localStorage.removeItem("showLoginAfterReset");
                        if (typeof CyberModal !== "undefined" && typeof CyberModal.open === "function") {
                            CyberModal.open();
                        }
                    }
                } catch (e) { console.warn(e); }
            };
            document.body.appendChild(s);
        }

        const headerContainer = document.getElementById('header-container');

        if (headerContainer && headerContainer.children.length > 0) {
            injectAuthScript();
        } else if (headerContainer) {
            const obs = new MutationObserver((mutations, observer) => {
                for (const m of mutations) {
                    if (m.type === 'childList' && m.addedNodes.length > 0) {
                        injectAuthScript();
                        observer.disconnect();
                        return;
                    }
                }
            });
            obs.observe(headerContainer, { childList: true, subtree: false });
        } else {
            // fallback polling
            let tries = 0;
            const t = setInterval(() => {
                const hc = document.getElementById('header-container');
                tries++;
                if (hc && hc.children.length > 0) {
                    clearInterval(t);
                    injectAuthScript();
                } else if (tries > 40) {
                    clearInterval(t);
                    injectAuthScript(); // best-effort
                }
            }, 100);
        }
    })();
</script>
</body>
</html>