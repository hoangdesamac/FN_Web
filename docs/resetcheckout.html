<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng - 3TD Shop</title>
    <link rel="icon" type="image/png" href="Image_Showroom/Slogan_w_logo.png">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts: Rajdhani -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&family=Audiowide&family=Syncopate:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <!-- ✅ Boxicons -->
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <!-- Custom Cyber CSS -->
    <link rel="stylesheet" href="HTML/Style/common.css">
    <link rel="stylesheet" href="HTML/Style/resetcheckout.css">
    <script>
        window.API_BASE = "https://fn-web.onrender.com";
    </script>

    <!-- AuthSync: canonical auth synchronizer (loads early) -->
    <script src="Script/js_authsync.js" defer></script>
    <script src="Script/js_cartcount.js" defer></script>
    <script src="Script/js_ordercount.js" defer></script>

    <!-- Guard: prevent immediate automatic modal open during initial page load for guest-with-cart.
         We still allow the modal to open if a safe per-tab flag (session) is present or after the grace period. -->
    <script>
        (function () {
            // small grace window (ms) where automatic opens will be blocked unless the per-tab flag exists
            window.__preventAutoOpenUntil = Date.now() + 1200;

            function safeConsumeFlagFallback() {
                try {
                    if (typeof sessionStorage !== 'undefined' && sessionStorage.getItem('showLoginAfterReset') === 'true') {
                        try { sessionStorage.removeItem('showLoginAfterReset'); } catch (_) {}
                        return true;
                    }
                    const v = localStorage.getItem('showLoginAfterReset');
                    if (!v) return false;
                    const ts = Number(localStorage.getItem('showLoginAfterReset_ts') || '0');
                    if (ts && (Date.now() - ts) < 10 * 1000) {
                        try { localStorage.removeItem('showLoginAfterReset'); localStorage.removeItem('showLoginAfterReset_ts'); } catch (_) {}
                        return true;
                    }
                    try { localStorage.removeItem('showLoginAfterReset'); localStorage.removeItem('showLoginAfterReset_ts'); } catch (_) {}
                    return false;
                } catch (e) {
                    try { localStorage.removeItem('showLoginAfterReset'); localStorage.removeItem('showLoginAfterReset_ts'); } catch (_) {}
                    try { sessionStorage.removeItem('showLoginAfterReset'); } catch (_) {}
                    return false;
                }
            }

            function wrapCyberModalOpenWhenReady() {
                try {
                    if (!window.CyberModal || typeof window.CyberModal.open !== 'function') return;
                    if (window.CyberModal._openWrapped) return;

                    const origOpen = window.CyberModal.open.bind(window.CyberModal);
                    window.CyberModal.open = function (...args) {
                        try {
                            // If a canonical helper exists, prefer it.
                            let consumed = false;
                            if (typeof window._consumeShowLoginFlag === 'function') {
                                try { consumed = !!window._consumeShowLoginFlag(); } catch (e) { consumed = false; }
                            } else {
                                consumed = safeConsumeFlagFallback();
                            }

                            // If flag consumed -> allow open (this tab requested it).
                            if (consumed) return origOpen(...args);

                            // Otherwise block auto-open during the initial grace period to avoid annoying popups
                            if (Date.now() < (window.__preventAutoOpenUntil || 0)) {
                                console.info('Blocked automatic CyberModal.open during initial grace period');
                                return;
                            }

                            // Outside the grace period, allow open.
                            return origOpen(...args);
                        } catch (e) {
                            // On any error, fall back to original behavior
                            try { return origOpen(...args); } catch (_) { /* swallow */ }
                        }
                    };
                    window.CyberModal._openWrapped = true;
                } catch (e) {
                    // ignore
                }
            }

            // Poll for CyberModal to be defined then wrap
            const poll = setInterval(() => {
                wrapCyberModalOpenWhenReady();
                if (window.CyberModal && window.CyberModal._openWrapped) clearInterval(poll);
            }, 80);

            // Try to wrap on DOMContentLoaded too
            document.addEventListener('DOMContentLoaded', wrapCyberModalOpenWhenReady);
        })();
    </script>
</head>

<body class="cyber-body">
<div id="header-container"></div>

<!-- Banner container (for non-blocking CTA) -->
<div id="login-cta-banner-wrapper" style="position:relative; z-index:40;"></div>

<div class="container-fluid checkout-container cyber-main">
    <!-- Breadcrumb Steps -->
    <div class="breadcrumb-steps d-flex justify-content-between align-items-center mb-4 p-3 rounded">
        <div class="step active" id="breadcrumb-step-1">
            <i class="fa fa-shopping-cart"></i> Giỏ hàng
        </div>
        <div class="step" id="breadcrumb-step-2">
            <i class="fa fa-truck"></i> Giao hàng
        </div>
        <div class="step" id="breadcrumb-step-3">
            <i class="fa fa-credit-card"></i> Thanh toán
        </div>
    </div>

    <!-- Checkout Step: Cart -->
    <div class="checkout-step cart-step" id="step-1">
        <div class="cart-header mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="cart-title mb-0">Giỏ hàng của bạn</h2>
                <button class="clear-cart-btn btn btn-danger" id="clear-cart">
                    <i class="fa fa-trash"></i> Xóa tất cả
                </button>
            </div>
            <div class="select-all-wrapper mt-2 d-flex align-items-center">
                <input type="checkbox" id="select-all-checkbox" class="form-check-input me-2">
                <label for="select-all-checkbox" class="text-light fw-semibold">Chọn tất cả</label>
            </div>
        </div>

        <!-- Empty Cart -->
        <div class="empty-cart d-flex flex-column align-items-center justify-content-center text-center rounded" id="empty-cart">
            <div id="empty-cart-lottie" class="mb-3"></div>
            <h3 class="empty-cart__title">Giỏ hàng của bạn đang trống</h3>
            <p class="empty-cart__message">Hãy khám phá cửa hàng và thêm những sản phẩm yêu thích vào giỏ hàng!</p>
            <a href="index.html" class="continue-shopping btn btn-primary mt-4" id="continue-shopping-btn">Tiếp tục mua sắm</a>
        </div>

        <!-- Cart Items -->
        <div class="cart-items" id="cart-items-container"></div>

        <!-- Cart Summary -->
        <div class="cart-summary p-4 rounded">
            <h3 class="cart-summary__title">Tóm tắt đơn hàng</h3>
            <div class="promo-banner d-flex align-items-center p-3 mb-4 rounded">
                <i class="fa fa-gift me-2"></i>
                <p>Miễn phí vận chuyển cho đơn hàng từ 500.000₫</p>
            </div>
            <div class="cart-summary__rows">
                <div class="summary-row d-flex justify-content-between mb-2">
                    <span class="summary-row__label">Tạm tính:</span>
                    <span class="summary-row__value currency-value">0₫</span>
                </div>
                <div class="summary-row d-flex justify-content-between mb-2">
                    <span class="summary-row__label">Phí vận chuyển:</span>
                    <span class="summary-row__value currency-value">Miễn phí</span>
                </div>
                <div class="summary-row summary-row--total d-flex justify-content-between mt-3 pt-3">
                    <span class="summary-row__label">Tổng cộng:</span>
                    <span class="summary-row__value currency-value">0₫</span>
                </div>
            </div>
            <div class="step-navigation d-flex flex-wrap justify-content-between gap-3 mt-4">
                <a href="index.html" class="btn btn-outline-primary flex-grow-1 text-center">
                    Tiếp tục mua sắm
                </a>
                <button class="btn btn-success btn--checkout flex-grow-1 text-center" id="proceed-to-step-2">
                    Đặt hàng ngay
                </button>
            </div>

        </div>
    </div>

    <!-- Checkout Step: Delivery -->
    <div class="checkout-step delivery-step d-none" id="step-2">
        <h2 class="cart-title mb-4">Thông tin giao hàng</h2>

        <!-- Radio chọn chế độ -->
        <div class="delivery-option d-flex gap-4 mb-3">
            <label class="form-check-label">
                <input type="radio" name="deliveryMode" value="profile" class="form-check-input" checked>
                Của bạn
            </label>
            <label class="form-check-label">
                <input type="radio" name="deliveryMode" value="custom" class="form-check-input">
                Thông tin khác
            </label>
        </div>

        <!-- Modal nhỏ hiển thị thông tin từ Profile -->
        <div id="profile-delivery-box" class="card p-3 mb-3" style="display:none;">
            <h6 class="fw-bold mb-3">Thông tin giao hàng của bạn</h6>
            <div id="profile-addresses-list"></div>
        </div>

        <!-- Form nhập thông tin khác -->
        <form id="custom-delivery-form" class="delivery-form">
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="recipient-name" class="form-label">Họ và tên <i class="fas fa-asterisk text-danger required-icon"></i></label>
                    <input type="text" class="form-control" id="recipient-name">
                </div>
                <div class="col-md-6">
                    <label for="recipient-phone" class="form-label">Số điện thoại <i class="fas fa-asterisk text-danger required-icon"></i></label>
                    <input type="tel" class="form-control" id="recipient-phone">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label for="province" class="form-label">Tỉnh/Thành phố <i class="fas fa-asterisk text-danger required-icon"></i></label>
                    <select id="province" class="form-select">
                        <option value="">-- Chọn Tỉnh/Thành phố --</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="ward" class="form-label">Phường/Xã <i class="fas fa-asterisk text-danger required-icon"></i></label>
                    <select id="ward" class="form-select">
                        <option value="">-- Chọn Phường/Xã --</option>
                    </select>
                </div>
            </div>
            <div class="mb-3">
                <label for="recipient-address" class="form-label">Địa chỉ chi tiết <i class="fas fa-asterisk text-danger required-icon"></i></label>
                <input type="text" class="form-control" id="recipient-address">
            </div>
        </form>

        <!-- Phần luôn hiển thị -->
        <div id="extra-options" class="mt-4">
            <!-- Ghi chú -->
            <div class="mb-3">
                <label for="note" class="form-label">Ghi chú (tùy chọn)</label>
                <textarea class="form-control" id="note" rows="2"></textarea>
            </div>

            <!-- Hai checkbox trên cùng 1 hàng -->
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                <!-- Xuất hóa đơn -->
                <div class="form-check mb-0">
                    <input type="checkbox" id="invoice-required" class="form-check-input" checked>
                    <label for="invoice-required" class="form-check-label">Xuất hóa đơn</label>
                </div>

                <!-- Đồng ý chính sách -->
                <div class="form-check mb-0">
                    <input type="checkbox" id="agree-terms" class="form-check-input">
                    <label for="agree-terms" class="form-check-label">
                        Tôi đồng ý với
                        <a href="#" class="text-cyber fw-bold" data-bs-toggle="modal" data-bs-target="#terms-modal">
                            Chính sách &amp; Điều khoản sử dụng
                        </a>
                    </label>
                </div>
            </div>


            <!-- Nút điều hướng -->
            <div class="step-navigation d-flex justify-content-between gap-3 mt-4">
                <button type="button" class="btn btn-outline-primary flex-fill" onclick="showStep(1)">Quay lại</button>
                <button type="button" class="btn btn-success flex-fill" id="proceed-to-step-3">Tiếp tục</button>
            </div>
        </div>

    </div>

    <!-- Checkout Step: Payment -->
    <div class="checkout-step payment-step d-none" id="step-3">
        <h2 class="cart-title mb-4">Xác nhận và thanh toán</h2>
        <div class="payment-content row">
            <div class="summary-section col-lg-7">
                <div class="info-card p-4 mb-4 rounded">
                    <h3>Thông tin giao hàng</h3>
                    <div class="info-card-content" id="delivery-summary"></div>
                </div>
                <div class="info-card p-4 rounded">
                    <h3>Chi tiết đơn hàng</h3>
                    <div id="order-summary"></div>
                </div>
            </div>

            <div class="payment-section col-lg-5">
                <div class="payment-card p-4 rounded">
                    <h4>Phương thức thanh toán</h4>
                    <div class="method-option p-3 mb-3 rounded selected cod" data-method="cod">
                        <label for="cod" class="d-flex align-items-center gap-2">
                            <input type="radio" name="payment-method" id="cod" value="cod" checked>
                            <div id="lottie-cod" class="lottie-animation"></div>
                            <span>Thanh toán khi nhận hàng (COD)</span>
                        </label>
                    </div>

                    <p class="payment-note">*Lưu ý: Quý khách chỉ thanh toán sau khi nhận được đơn hàng!</p>
                    <div class="d-flex gap-3 mt-4">
                        <button type="button" class="btn btn-outline-primary flex-fill" onclick="showStep(2)">
                            Quay lại
                        </button>
                        <button class="btn btn-success flex-fill" id="payment-btn" onclick="showConfirmation()">
                            Thanh toán
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals and other elements unchanged ... -->
    <!-- (omitted here for brevity; keep the same modal markup as original) -->

</div>
<div id="footer-container"></div>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<!-- Bootstrap 5 JS and Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
<!-- Lottie Animation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>
<!-- Confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<!-- Tom Select CSS -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
<!-- Tom Select JS -->
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<!-- Custom JS -->
<script src="Script/js_header.js" defer></script>
<script src="Script/js_resetcheckout.js" defer></script>

<!-- Ensure auth script loads only after header is present.
     When header is injected by js_resetcheckout.js, we inject js_resetauth.js and call AuthSync.refresh()
     so header UI updates immediately and modal-open flag is handled similarly to other pages. -->
<script>
    (function() {
        let authInjected = false;

        function injectAuth() {
            if (authInjected) return;
            authInjected = true;

            const s = document.createElement('script');
            s.src = "Script/js_resetauth.js";
            s.defer = true;
            s.onload = async function() {
                try {
                    if (window.AuthSync && typeof window.AuthSync.refresh === 'function') {
                        await window.AuthSync.refresh();
                    }
                } catch (err) {
                    console.warn('AuthSync.refresh() failed on checkout page:', err);
                }

                // ----- Ensure header UI is updated now that AuthSync has refreshed -----
                try {
                    if (typeof updateUserDisplay === 'function') await updateUserDisplay();
                    if (typeof updateCartCount === 'function') updateCartCount();
                    if (typeof updateOrderCount === 'function') updateOrderCount();
                } catch (e) {
                    console.warn('Post-refresh header update (checkout) failed:', e);
                }

                // Safe consume flag (prefer exported helper)
                try {
                    let consumed = false;
                    if (typeof window._consumeShowLoginFlag === 'function') {
                        try { consumed = !!window._consumeShowLoginFlag(); } catch (err) { consumed = false; }
                    } else {
                        try {
                            if (typeof sessionStorage !== 'undefined' && sessionStorage.getItem('showLoginAfterReset') === 'true') {
                                try { sessionStorage.removeItem('showLoginAfterReset'); } catch (_) {}
                                consumed = true;
                            } else {
                                const v = localStorage.getItem('showLoginAfterReset');
                                if (v) {
                                    const ts = Number(localStorage.getItem('showLoginAfterReset_ts') || '0');
                                    if (ts && (Date.now() - ts) < 10 * 1000) {
                                        try { localStorage.removeItem('showLoginAfterReset'); localStorage.removeItem('showLoginAfterReset_ts'); } catch (_) {}
                                        consumed = true;
                                    } else {
                                        try { localStorage.removeItem('showLoginAfterReset'); localStorage.removeItem('showLoginAfterReset_ts'); } catch (_) {}
                                        consumed = false;
                                    }
                                }
                            }
                        } catch (e) { consumed = false; }
                    }

                    if (consumed) {
                        if (typeof CyberModal !== "undefined" && typeof CyberModal.open === "function") {
                            CyberModal.open();
                        }
                    } else {
                        // If not consumed (normal guest/no explicit per-tab request), show a gentle banner
                        try { showLoginBannerIfGuest(); } catch (e) {}
                    }
                } catch (e) { console.warn(e); }
            };
            document.body.appendChild(s);
        }

        // Show non-blocking banner for guests who have items in cart (do not auto open modal)
        function showLoginBannerIfGuest() {
            try {
                // Quick auth check (in-memory AuthSync preferred)
                let logged = false;
                try {
                    if (window.AuthSync && typeof window.AuthSync.getState === 'function') {
                        const st = window.AuthSync.getState();
                        logged = !!(st && st.loggedIn);
                    } else {
                        logged = !!localStorage.getItem('userName') || !!localStorage.getItem('userId');
                    }
                } catch (e) {
                    logged = !!localStorage.getItem('userName') || !!localStorage.getItem('userId');
                }
                if (logged) return;

                const cart = JSON.parse(localStorage.getItem('cart') || '[]') || [];
                const giftCart = JSON.parse(localStorage.getItem('giftCart') || '[]') || [];
                const normal = Array.isArray(cart) ? cart.reduce((t, i) => t + (Number(i.quantity) || 0), 0) : 0;
                const gifts = Array.isArray(giftCart) ? giftCart.reduce((t, i) => t + (Number(i.quantity) || 0), 0) : 0;
                const totalItems = normal + gifts;
                const isLocked = localStorage.getItem('cartLocked') === 'true';

                if (totalItems > 0 && !isLocked) {
                    // create banner if not exists
                    if (!document.getElementById('login-required-banner')) {
                        const wrapper = document.getElementById('login-cta-banner-wrapper') || document.body;
                        const banner = document.createElement('div');
                        banner.id = 'login-required-banner';
                        banner.className = 'p-3';
                        banner.style.cssText = 'background: linear-gradient(90deg,#fff8e1,#fff); border:1px solid #ffd54f; display:flex; align-items:center; justify-content:center; gap:12px;';
                        banner.innerHTML = `
                            <div style="flex:1; text-align:center;">
                                Bạn có <strong>${totalItems}</strong> sản phẩm trong giỏ. Đăng nhập để lưu & thanh toán nhanh hoặc tiếp tục xem sản phẩm.
                            </div>
                            <div style="display:flex; gap:8px;">
                                <button id="open-login-cta" class="btn btn-sm btn-primary">Đăng nhập</button>
                                <button id="continue-guest" class="btn btn-sm btn-outline-secondary">Tiếp tục xem</button>
                            </div>
                        `;
                        wrapper.appendChild(banner);

                        document.getElementById('open-login-cta').addEventListener('click', () => {
                            try {
                                // prefer per-tab modal; set session flag and open
                                try {
                                    if (typeof window.setShowLoginAfterReset === 'function') window.setShowLoginAfterReset(true);
                                    else if (typeof sessionStorage !== 'undefined') sessionStorage.setItem('showLoginAfterReset','true');
                                } catch (_) {}
                                if (typeof CyberModal !== 'undefined' && typeof CyberModal.open === 'function') CyberModal.open();
                            } catch (e) { console.warn(e); }
                        });

                        document.getElementById('continue-guest').addEventListener('click', () => {
                            try { banner.remove(); } catch (e) {}
                            // reveal checkout if it was hidden by legacy script
                            try {
                                const container = document.querySelector('.checkout-container');
                                if (container) container.classList.remove('d-none');
                            } catch (e) {}
                        });

                        // Also ensure checkout container visible (we prefer not to force modal)
                        try {
                            const container = document.querySelector('.checkout-container');
                            if (container) container.classList.remove('d-none');
                        } catch (e) {}
                    }
                }
            } catch (err) {
                console.warn('showLoginBannerIfGuest error', err);
            }
        }

        // If header already exists (synchronous), inject immediately
        const headerContainer = document.getElementById('header-container');
        if (headerContainer && headerContainer.children.length > 0) {
            injectAuth();
            return;
        }

        // Observe header container for insertion (triggered by js_resetcheckout.loadPagePart)
        if (headerContainer) {
            const obs = new MutationObserver((mutations, observer) => {
                for (const m of mutations) {
                    if (m.type === 'childList' && m.addedNodes.length > 0) {
                        injectAuth();
                        observer.disconnect();
                        return;
                    }
                }
            });
            obs.observe(headerContainer, { childList: true, subtree: false });
        } else {
            // fallback: poll for header for a short time
            let tries = 0;
            const t = setInterval(() => {
                const hc = document.getElementById('header-container');
                tries++;
                if (hc && hc.children.length > 0) {
                    clearInterval(t);
                    injectAuth();
                } else if (tries > 40) {
                    clearInterval(t);
                    // best-effort inject anyway to avoid missing auth
                    injectAuth();
                }
            }, 100);
        }

        // Also attempt a best-effort banner check on DOMContentLoaded in case auth not injected yet
        document.addEventListener('DOMContentLoaded', function() {
            try { setTimeout(showLoginBannerIfGuest, 400); } catch (e) {}
        });
    })();
</script>
</body>
</html>